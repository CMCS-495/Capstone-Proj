<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Battle vs {{ enemy.name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Hidden, looping background music -->
  <audio id="bgm" loop preload="auto" autoplay style="display:none">
    <source src="{{ url_for('static', filename='audio/escape-the-dungeon-dubious-dungeon.mp3') }}" type="audio/mpeg">
    Your browser doesnâ€™t support HTML5 audio.
  </audio>
  <script src="{{ url_for('static', filename='bgm.js') }}"></script>
  <div class="container">
    <h1>Battle: {{ player.name }} vs {{ enemy.name }}</h1>
    <div class="stats">
      <div>Your HP: {{ player.hp }}</div>
      <div>Enemy HP: {{ enemy.current_hp }} / {{ enemy.max_hp }}</div>
      <div>Potions: {{ potions }}</div>
    </div>
    <hr>
    {% for msg in messages %}
      <p>{{ msg|safe }}</p>
    {% endfor %}

    {% if outcome == 'ongoing' %}
      <form method="post">
        <button name="action" value="attack">Attack</button>
        <button name="action" value="defend">Defend</button>
        {% if potions > 0 %}
          <button name="action" value="potion">Use Potion</button>
        {% endif %}
        <button name="action" value="run">Run</button>
        
        <!-- Launch Save-As dialog -->
        <a class="button" href="{{ url_for('save_as') }}">ðŸ’¾ Save Asâ€¦</a>
      </form>
    {% elif outcome == 'defeat' %}
      <h2>Game Over</h2>
      <a href="{{ url_for('menu') }}">Restart</a>
    {% elif outcome == 'victory' %}
      <h2>You conquered the dungeon!</h2>
      <a href="{{ url_for('menu') }}">Play Again</a>
    {% endif %}
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('loading-overlay');
    // Show overlay
    const show = () => overlay.style.display = 'flex';

    // Any form submitâ€¦
    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', show);
    });
    // Any internal link clickâ€¦
    document.querySelectorAll('a[href]').forEach(a => {
      const href = a.getAttribute('href');
      if(href.startsWith('/') && !href.startsWith('//')) {
        a.addEventListener('click', show);
      }
    });
  });
  </script>
</body>
</html>
